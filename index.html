<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="chapTAP Autofix - Premium roadside assistance in Kenya" />
  <title>chapTAP Autofix - Premium Roadside Assistance Kenya</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ICONS
    const Phone = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M22 16.92v3a2 2 0 0 1-2.18 2A19.8 19.8 0 0 1 3.26 5.18 2 2 0 0 1 5.11 2h3a2 2 0 0 1 2 1.72 12.8 12.8 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.8 12.8 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
      </svg>
    );
    const MessageCircle = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
      </svg>
    );
    const Star = ({ size = 16, filled = true }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2">
        <polygon points="12 2 15 8 22 9 17 14 18 21 12 18 6 21 7 14 2 9 9 8 12 2"/>
      </svg>
    );
    const MapPin = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
        <circle cx="12" cy="10" r="3"/>
      </svg>
    );
    const AlertCircle = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
    );
    const X = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    );
    const Navigation = ({ size = 16 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polygon points="3 11 22 2 13 21 11 13 3 11"/>
      </svg>
    );
    const Send = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="22" y1="2" x2="11" y2="13"/>
        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
      </svg>
    );
    const Bell = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
      </svg>
    );
    const Upload = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
    );
    const Check = ({ size = 20 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    );
    const TrendingUp = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
        <polyline points="17 6 23 6 23 12"/>
      </svg>
    );
    const Users = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
    );
    const DollarSign = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <line x1="12" y1="1" x2="12" y2="23"/>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
      </svg>
    );

    // LOCAL STORAGE UTILITIES
    const storage = {
      get: (key) => {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : null;
        } catch (e) {
          return null;
        }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.error('Storage error:', e);
        }
      }
    };

    // MAIN APP
    const ChapTapAutofix = () => {
      const [userType, setUserType] = useState('driver');
      const [currentView, setCurrentView] = useState('home');
      const [providers, setProviders] = useState([]);
      const [shops, setShops] = useState([]);
      const [requests, setRequests] = useState([]);
      const [ratings, setRatings] = useState([]);
      const [chats, setChats] = useState({});
      const [notifications, setNotifications] = useState([]);
      const [location, setLocation] = useState(null);
      const [gpsActive, setGpsActive] = useState(false);
      const [showEmergencyModal, setShowEmergencyModal] = useState(false);
      const [showAdminAuth, setShowAdminAuth] = useState(false);
      const [adminPin, setAdminPin] = useState('');
      const [showNotifications, setShowNotifications] = useState(false);
      const [selectedProvider, setSelectedProvider] = useState(null);
      const [showChat, setShowChat] = useState(false);
      const [showRating, setShowRating] = useState(false);
      const [selectedRequest, setSelectedRequest] = useState(null);

      // Emergency request form
      const [emergencyForm, setEmergencyForm] = useState({
        issue: '',
        locationType: 'roadside',
        locationDesc: '',
        files: []
      });

      // Provider registration form
      const [providerForm, setProviderForm] = useState({
        name: '', phone: '', services: [], experience: '', idNumber: '', location: ''
      });

      // Load data on mount
      useEffect(() => {
        const savedProviders = storage.get('providers') || [
          { id:1, name:'Mike Garage', phone:'0721122334', services:['Towing','Tyre'], location:'Nyali', rating:4.5, status:'Approved', available: true },
          { id:2, name:'Quick Fix Auto', phone:'0733445566', services:['Battery'], location:'CBD', rating:4.3, status:'Approved', available: true },
          { id:3, name:'Roadside Rescue', phone:'0744556677', services:['Towing','Mechanical'], location:'Likoni', rating:4.7, status:'Approved', available: false }
        ];
        setProviders(savedProviders);

        const savedShops = storage.get('shops') || [
          { id:1, name:'Mombasa Oils Centre', location:'Nyali', type:'Lubricants', products:'Engine Oil, Brake Fluid', phone:'0712345678', rating:4.5 },
          { id:2, name:'AutoSpare Hub', location:'Changamwe', type:'Parts', products:'Belts, Plugs', phone:'0721987654', rating:4.3 },
          { id:3, name:'Tyre World', location:'CBD', type:'Tyres', products:'All Tyre Brands', phone:'0733221100', rating:4.6 }
        ];
        setShops(savedShops);

        setRequests(storage.get('requests') || []);
        setRatings(storage.get('ratings') || []);
        setChats(storage.get('chats') || {});
        setNotifications(storage.get('notifications') || []);

        requestLocation();
      }, []);

      // Save data on changes
      useEffect(() => { storage.set('providers', providers); }, [providers]);
      useEffect(() => { storage.set('requests', requests); }, [requests]);
      useEffect(() => { storage.set('ratings', ratings); }, [ratings]);
      useEffect(() => { storage.set('chats', chats); }, [chats]);
      useEffect(() => { storage.set('notifications', notifications); }, [notifications]);

      const requestLocation = () => {
        if (navigator.geolocation) {
          setGpsActive(true);
          navigator.geolocation.getCurrentPosition(
            (position) => {
              setLocation({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              });
            },
            () => setGpsActive(false)
          );
        }
      };

      const addNotification = (message, type = 'info') => {
        const newNotif = { id: Date.now(), message, type, timestamp: new Date().toLocaleString() };
        setNotifications(prev => [newNotif, ...prev]);
      };

      const handleEmergencySubmit = () => {
        if (!emergencyForm.issue || !emergencyForm.locationDesc) {
          alert('Please fill all required fields');
          return;
        }

        const newRequest = {
          id: Date.now(),
          ...emergencyForm,
          location: location,
          status: 'Open',
          paymentStatus: 'Pending',
          timestamp: new Date().toLocaleString(),
          driverName: 'Current User'
        };

        setRequests(prev => [newRequest, ...prev]);
        addNotification('Emergency request submitted!', 'success');
        setShowEmergencyModal(false);
        setEmergencyForm({ issue: '', locationType: 'roadside', locationDesc: '', files: [] });
      };

      const handleFileUpload = (e) => {
        const files = Array.from(e.target.files);
        setEmergencyForm(prev => ({ ...prev, files: files.map(f => f.name) }));
      };

      const handleProviderRegistration = () => {
        if (!providerForm.name || !providerForm.phone || providerForm.services.length === 0) {
          alert('Please fill all required fields');
          return;
        }

        const newProvider = {
          id: Date.now(),
          ...providerForm,
          status: 'Pending',
          rating: 0,
          available: false
        };

        setProviders(prev => [...prev, newProvider]);
        addNotification('Registration submitted for approval', 'info');
        setCurrentView('home');
        setProviderForm({ name: '', phone: '', services: [], experience: '', idNumber: '', location: '' });
      };

      const toggleService = (service) => {
        setProviderForm(prev => ({
          ...prev,
          services: prev.services.includes(service)
            ? prev.services.filter(s => s !== service)
            : [...prev.services, service]
        }));
      };

      const approveProvider = (id) => {
        setProviders(prev => prev.map(p => p.id === id ? { ...p, status: 'Approved', available: true } : p));
        addNotification('Provider approved successfully', 'success');
      };

      const rejectProvider = (id) => {
        setProviders(prev => prev.map(p => p.id === id ? { ...p, status: 'Rejected' } : p));
        addNotification('Provider rejected', 'error');
      };

      const sendMessage = (providerId, message) => {
        const chatKey = `chat_${providerId}`;
        const newMessage = { sender: 'user', text: message, timestamp: new Date().toLocaleString() };
        setChats(prev => ({
          ...prev,
          [chatKey]: [...(prev[chatKey] || []), newMessage]
        }));
      };

      const submitRating = (requestId, rating, comment) => {
        const newRating = { id: Date.now(), requestId, rating, comment, timestamp: new Date().toLocaleString() };
        setRatings(prev => [...prev, newRating]);
        setRequests(prev => prev.map(r => r.id === requestId ? { ...r, status: 'Completed' } : r));
        addNotification('Rating submitted. Thank you!', 'success');
        setShowRating(false);
        setSelectedRequest(null);
      };

      const handleAdminAccess = () => {
        if (adminPin === '1234') {
          setUserType('admin');
          setShowAdminAuth(false);
          setCurrentView('home');
        } else {
          alert('Invalid PIN');
        }
      };

      const getStats = () => {
        const totalRequests = requests.length;
        const openRequests = requests.filter(r => r.status === 'Open').length;
        const completedRequests = requests.filter(r => r.status === 'Completed').length;
        const totalRevenue = completedRequests * 500;
        const pendingProviders = providers.filter(p => p.status === 'Pending').length;

        return { totalRequests, openRequests, completedRequests, totalRevenue, pendingProviders };
      };

      const getIssueBreakdown = () => {
        const breakdown = {};
        requests.forEach(r => {
          breakdown[r.issue] = (breakdown[r.issue] || 0) + 1;
        });
        return breakdown;
      };

      const emergencyContacts = [
        { name: 'Police Emergency', number: '999', color: 'bg-blue-600' },
        { name: 'Ambulance', number: '911', color: 'bg-red-600' },
        { name: 'Fire Department', number: '998', color: 'bg-orange-600' },
        { name: 'chapTAP Autofix Support', number: '0712345678', color: 'bg-yellow-600' }
      ];

      const stats = getStats();
      const issueBreakdown = getIssueBreakdown();

      return (
        <div className="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100 pb-24">
          {/* HEADER */}
          <div className="bg-gradient-to-r from-black via-gray-900 to-black border-b-4 border-yellow-500 shadow-xl sticky top-0 z-40">
            <div className="max-w-md mx-auto p-6 text-center relative">
              <h1 className="text-3xl font-black tracking-wider mb-1">
                <span className="text-yellow-400">chap</span>
                <span className="text-white">TAP</span>
              </h1>
              <p className="text-yellow-200 text-xs font-bold">Autofix - Premium Roadside Assistance</p>
              
              {gpsActive && location && (
                <div className="mt-3 inline-flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg">
                  <Navigation size={14} />
                  GPS ACTIVE
                </div>
              )}

              {/* User Type Toggle */}
              <div className="mt-4 flex gap-2 justify-center">
                <button
                  onClick={() => { setUserType('driver'); setCurrentView('home'); }}
                  className={`px-4 py-2 rounded-lg font-bold text-xs ${userType === 'driver' ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white'}`}
                >
                  Driver
                </button>
                <button
                  onClick={() => setShowAdminAuth(true)}
                  className={`px-4 py-2 rounded-lg font-bold text-xs ${userType === 'admin' ? 'bg-yellow-500 text-black' : 'bg-gray-700 text-white'}`}
                >
                  Admin
                </button>
              </div>

              {/* Notifications Bell */}
              <button
                onClick={() => setShowNotifications(!showNotifications)}
                className="absolute top-6 right-6 text-yellow-400 relative"
              >
                <Bell size={24} />
                {notifications.length > 0 && (
                  <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold">
                    {notifications.length}
                  </span>
                )}
              </button>
            </div>
          </div>

          {/* NOTIFICATIONS PANEL */}
          {showNotifications && (
            <div className="max-w-md mx-auto bg-white shadow-xl rounded-b-lg p-4 absolute top-32 left-0 right-0 z-30 max-h-96 overflow-y-auto">
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-bold text-lg">Notifications</h3>
                <button onClick={() => setShowNotifications(false)} className="text-gray-500">
                  <X size={20} />
                </button>
              </div>
              {notifications.length === 0 ? (
                <p className="text-gray-500 text-center py-4">No notifications</p>
              ) : (
                <div className="space-y-2">
                  {notifications.map(n => (
                    <div key={n.id} className={`p-3 rounded-lg ${n.type === 'success' ? 'bg-green-50 border-l-4 border-green-500' : n.type === 'error' ? 'bg-red-50 border-l-4 border-red-500' : 'bg-blue-50 border-l-4 border-blue-500'}`}>
                      <p className="text-sm font-semibold">{n.message}</p>
                      <p className="text-xs text-gray-500 mt-1">{n.timestamp}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          <div className="max-w-md mx-auto p-4">
            {/* DRIVER VIEW */}
            {userType === 'driver' && (
              <>
                {currentView === 'home' && (
                  <div className="space-y-4 mt-4">
                    <button
                      onClick={() => setShowEmergencyModal(true)}
                      className="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white py-4 rounded-xl font-black text-lg shadow-2xl transform hover:scale-105 transition-all flex items-center justify-center gap-3 border-2 border-red-400"
                    >
                      <AlertCircle size={28} />
                      üö® EMERGENCY HELP
                    </button>

                    <button
                      onClick={() => setCurrentView('providers')}
                      className="w-full bg-gradient-to-r from-black to-gray-800 text-yellow-400 py-4 rounded-xl font-black text-lg shadow-xl hover:shadow-2xl transform hover:scale-105 transition-all border-2 border-yellow-500"
                    >
                      ‚ö´üü° Find Service Providers
                    </button>

                    <button
                      onClick={() => setCurrentView('shops')}
                      className="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-black py-4 rounded-xl font-black text-lg shadow-xl transform hover:scale-105 transition-all border-2 border-yellow-300"
                    >
                      üü° Browse Auto Shops
                    </button>

                    <button
                      onClick={() => setCurrentView('register-provider')}
                      className="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all"
                    >
                      Register as Service Provider
                    </button>

                    <button
                      onClick={() => setCurrentView('my-requests')}
                      className="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all"
                    >
                      My Request History ({requests.length})
                    </button>
                  </div>
                )}

                {currentView === 'providers' && (
                  <div className="space-y-4 mt-4">
                    <button onClick={() => setCurrentView('home')} className="text-blue-600 font-bold flex items-center gap-2">
                      ‚Üê Back
                    </button>
                    <h2 className="text-2xl font-black text-gray-800">Service Providers</h2>
                    {providers.filter(p => p.status === 'Approved').map(p => (
                      <div key={p.id} className="bg-white p-5 rounded-xl shadow-lg border-l-4 border-yellow-500">
                        <div className="flex justify-between items-start mb-3">
                          <div>
                            <div className="font-black text-lg">{p.name}</div>
                            <div className="text-sm text-gray-600 flex items-center gap-1">
                              <MapPin size={14} /> {p.location}
                            </div>
                            <div className="text-sm text-blue-600 font-semibold">{p.services.join(' ‚Ä¢ ')}</div>
                            <div className={`inline-block mt-2 px-2 py-1 rounded text-xs font-bold ${p.available ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                              {p.available ? 'Available' : 'Busy'}
                            </div>
                          </div>
                          <div className="flex items-center gap-1 bg-yellow-100 px-2 py-1 rounded-full">
                            <Star className="text-yellow-500" size={14} />
                            <span className="font-bold text-sm">{p.rating}</span>
                          </div>
                        </div>
                        <div className="grid grid-cols-3 gap-2 mt-4">
                          <a href={`tel:${p.phone}`} className="bg-blue-600 text-white py-2 rounded-lg text-center text-xs font-bold flex items-center justify-center gap-1">
                            <Phone size={14} /> Call
                          </a>
                          <a href={`https://wa.me/${p.phone.replace(/^0/, '254')}`} target="_blank" className="bg-green-600 text-white py-2 rounded-lg text-center text-xs font-bold flex items-center justify-center gap-1">
                            <MessageCircle size={14} /> WhatsApp
                          </a>
                          <button onClick={() => { setSelectedProvider(p); setShowChat(true); }} className="bg-purple-600 text-white py-2 rounded-lg text-xs font-bold">
                            Chat
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {currentView === 'shops' && (
                  <div className="space-y-4 mt-4">
                    <button onClick={() => setCurrentView('home')} className="text-blue-600 font-bold flex items-center gap-2">
                      ‚Üê Back
                    </button>
                    <h2 className="text-2xl font-black text-gray-800">Auto Shops</h2>
                    {shops.map(s => (
                      <div key={s.id} className="bg-white p-5 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <div className="flex justify-between items-start mb-2">
                          <div>
                            <div className="font-black text-lg">{s.name}</div>
                            <div className="text-sm text-gray-600 flex items-center gap-1">
                              <MapPin size={14} /> {s.location}
                            </div>
                          </div>
                          <div className="flex items-center gap-1 bg-yellow-100 px-2 py-1 rounded-full">
                            <Star className="text-yellow-500" size={14} />
                            <span className="font-bold text-sm">{s.rating}</span>
                          </div>
                        </div>
                        <div className="bg-blue-50 px-3 py-2 rounded-lg mb-2">
                          <div className="text-xs font-bold text-blue-800 uppercase">{s.type}</div>
                          <div className="text-sm text-gray-700 mt-1">{s.products}</div>
                        </div>
                        <div className="grid grid-cols-2 gap-2 mt-4">
                          <a href={`tel:${s.phone}`} className="bg-blue-600 text-white py-3 rounded-lg text-center font-bold flex items-center justify-center gap-2">
                            <Phone size={16} /> Call
                          </a>
                          <a href={`https://wa.me/${s.phone.replace(/^0/, '254')}`} target="_blank" className="bg-green-600 text-white py-3 rounded-lg text-center font-bold flex items-center justify-center gap-2">
                            <MessageCircle size={16} /> WhatsApp
                          </a>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {currentView === 'register-provider' && (
                  <div className="space-y-4 mt-4">
                    <button onClick={() => setCurrentView('home')} className="text-blue-600 font-bold flex items-center gap-2">
                      ‚Üê Back
                    </button>
                    <h2 className="text-2xl font-black text-gray-800">Register as Provider</h2>
                    <div className="bg-white p-6 rounded-xl shadow-lg space-y-4">
                      <input type="text" placeholder="Business Name" value={providerForm.name}
