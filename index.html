<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>chapTAP autofix</title><script src="https://cdn.tailwindcss.com"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><style>body{padding-bottom:100px}.star{cursor:pointer;font-size:24px;color:#ddd}.star.active{color:#fbbf24}</style></head><body class="bg-gray-50"><div class="bg-gradient-to-r from-black to-gray-900 border-b-4 border-yellow-500 p-6 text-center sticky top-0 z-50"><h1 class="text-3xl font-black"><span class="text-yellow-400">chap</span><span class="text-white">TAP</span> <span class="text-yellow-400">autofix</span></h1><p class="text-yellow-200 text-sm font-bold">Your help is a TAP away! ğŸ’¡</p><p id="gps" class="text-green-400 text-xs mt-1 hidden">ğŸ“ GPS Active</p><div class="flex gap-2 justify-center mt-4"><button onclick="setRole('user')" id="ru" class="px-4 py-2 rounded font-bold text-xs bg-yellow-500 text-black">User</button><button onclick="setRole('provider')" id="rp" class="px-4 py-2 rounded font-bold text-xs bg-gray-700 text-white">Provider</button><button onclick="setRole('admin')" id="ra" class="px-4 py-2 rounded font-bold text-xs bg-gray-700 text-white">Admin</button></div><button onclick="showNotifs()" class="absolute top-6 right-6 text-yellow-400 text-2xl">ğŸ””<span id="nb" class="text-xs bg-red-500 rounded-full px-1 hidden">0</span></button></div><div class="max-w-md mx-auto p-4"><div id="user"><div id="uh" class="space-y-4"><div class="bg-gradient-to-r from-yellow-400 to-yellow-500 p-4 rounded-xl text-black mb-4"><h2 class="text-xl font-black mb-1">Welcome! ğŸ‘‹</h2><p class="text-sm">24/7 Roadside Assistance</p></div><div class="grid grid-cols-2 gap-3 mb-4"><div class="bg-white p-3 rounded shadow text-center"><div class="text-2xl font-bold text-blue-600" id="hp-provs">0</div><div class="text-xs">Providers</div></div><div class="bg-white p-3 rounded shadow text-center"><div class="text-2xl font-bold text-green-600" id="hp-completed">0</div><div class="text-xs">Jobs Done</div></div></div><div id="ld" class="bg-green-50 border-l-4 border-green-500 p-3 rounded hidden"><p class="text-sm font-bold text-green-800">ğŸ“ Location</p><p id="co" class="text-xs text-green-700"></p></div><button onclick="getLoc()" id="lb" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">ğŸ“ Use Location</button><button onclick="show('em')" class="w-full bg-red-600 text-white py-4 rounded-xl font-black text-lg">ğŸš¨ REQUEST HELP</button><button onclick="show('pv')" class="w-full bg-black text-yellow-400 py-4 rounded-xl font-black">ğŸ” Providers</button><button onclick="show('ur')" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold">My Requests (<span id="urc">0</span>)</button></div><div id="pv" class="hidden space-y-4"><button onclick="show('uh')" class="text-blue-600 font-bold">â† Back</button><h2 class="text-2xl font-black">Providers</h2><div id="pl"></div></div><div id="ur" class="hidden space-y-4"><button onclick="show('uh')" class="text-blue-600 font-bold">â† Back</button><h2 class="text-2xl font-black">My Requests</h2><div id="url"></div></div><div id="quotes" class="hidden space-y-4"><button onclick="backFromQuotes()" class="text-blue-600 font-bold">â† Back</button><h2 class="text-2xl font-black">Quotes</h2><p class="text-sm mb-2">Request: <strong id="quotereqtitle"></strong></p><div id="quoteslist"></div></div></div><div id="provider" class="hidden"><div id="pl0" class="bg-white p-6 rounded-xl shadow"><h3 class="text-xl font-bold mb-4">Provider Login</h3><input type="tel" id="pp" placeholder="Phone" class="w-full p-3 border rounded mb-4"><button onclick="pLogin()" class="w-full bg-green-600 text-white py-2 rounded font-bold mb-2">Login</button><button onclick="show('preg')" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Register</button></div><div id="preg" class="hidden bg-white p-6 rounded-xl shadow"><h3 class="text-xl font-bold mb-4">Register</h3><input type="text" id="rname" placeholder="Business Name" class="w-full p-3 border rounded mb-3"><input type="tel" id="rphone" placeholder="Phone" class="w-full p-3 border rounded mb-3"><input type="text" id="rloc" placeholder="Location" class="w-full p-3 border rounded mb-3"><div class="bg-blue-50 p-3 rounded mb-3"><button onclick="captureProviderLocation()" id="cap-loc-btn" class="w-full bg-blue-600 text-white py-2 rounded font-bold mb-2">ğŸ“ Capture Location</button><div id="prov-loc-display" class="hidden text-xs text-green-700"><p>âœ… Captured</p><p id="prov-coords"></p></div></div><input type="number" id="ryears" placeholder="Years" class="w-full p-3 border rounded mb-3"><input type="text" id="rcert" placeholder="Certifications" class="w-full p-3 border rounded mb-3"><div class="mb-3"><label class="flex items-center"><input type="checkbox" value="Towing" class="mr-2 srv">Towing</label><label class="flex items-center"><input type="checkbox" value="Tyre" class="mr-2 srv">Tyre</label><label class="flex items-center"><input type="checkbox" value="Battery" class="mr-2 srv">Battery</label><label class="flex items-center"><input type="checkbox" value="Mechanical" class="mr-2 srv">Mechanical</label><label class="flex items-center"><input type="checkbox" value="Electrical" class="mr-2 srv">Electrical</label></div><button onclick="registerP()" class="w-full bg-green-600 text-white py-2 rounded font-bold">Submit</button><button onclick="show('pl0')" class="w-full bg-gray-300 py-2 rounded font-bold mt-2">Back</button></div><div id="pd" class="hidden space-y-4"><div class="bg-green-600 text-white p-6 rounded-xl"><h2 id="pn" class="text-2xl font-black"></h2><p id="plc" class="text-sm"></p><div class="text-sm mt-2">â­ <span id="provrat">0</span> (<span id="provrevs">0</span> reviews)</div><button onclick="toggleA()" id="ab" class="mt-4 w-full py-3 rounded font-bold bg-red-600">ğŸŸ¢ Offline</button></div><div class="bg-white p-4 rounded shadow"><h3 class="font-bold mb-2 text-sm">Prices</h3><input type="number" id="p1" placeholder="Towing" class="w-full p-2 border rounded mb-2 text-sm"><input type="number" id="p2" placeholder="Tyre" class="w-full p-2 border rounded mb-2 text-sm"><input type="number" id="p3" placeholder="Battery" class="w-full p-2 border rounded mb-2 text-sm"><input type="number" id="p4" placeholder="Mechanical" class="w-full p-2 border rounded mb-2 text-sm"><input type="number" id="p5" placeholder="Electrical" class="w-full p-2 border rounded mb-2 text-sm"><button onclick="savePrices()" class="w-full bg-blue-600 text-white py-1 rounded text-sm">Save</button></div><div class="grid grid-cols-2 gap-4"><div class="bg-white p-4 rounded shadow"><div id="tj" class="text-2xl font-bold text-blue-600">0</div><div class="text-sm">Jobs</div></div><div class="bg-white p-4 rounded shadow"><div id="cj" class="text-2xl font-bold text-green-600">0</div><div class="text-sm">Done</div></div></div><button onclick="show('ar')" class="w-full bg-blue-600 text-white py-3 rounded font-bold">Requests (<span id="arc">0</span>)</button><button onclick="show('myquotes')" class="w-full bg-yellow-500 text-black py-3 rounded font-bold">Quotes (<span id="myqc">0</span>)</button><button onclick="show('mj')" class="w-full bg-green-600 text-white py-3 rounded font-bold">Jobs (<span id="mjc">0</span>)</button></div><div id="ar" class="hidden space-y-4"><button onclick="show('pd')" class="text-blue-600 font-bold">â† Back</button><h2 class="text-2xl font-black">Send Quotes</h2><div id="arl"></div></div><div id="myquotes" class="hidden space-y-4"><button onclick="show('pd')" class="text-blue-600 font-bold">â† Back</button><h2 class="text-2xl font-black">My Quotes</h2><div id="myquoteslist"></div></div><div id="mj" class="hidden space-y-4"><button onclick="show('pd')" class="text-blue-600 font-bold">â† Back</button><h2 class="text-2xl font-black">Active Jobs</h2><div id="mjl"></div></div></div><div id="admin" class="hidden"><div id="al" class="bg-white p-6 rounded-xl shadow"><h3 class="text-xl font-bold mb-4">Admin Login</h3><input type="password" id="ap" placeholder="PIN (1234)" class="w-full p-3 border rounded mb-4"><button onclick="aLogin()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Login</button></div><div id="ad" class="hidden space-y-4"><h2 class="text-2xl font-black">Dashboard</h2><div class="flex gap-2 mb-4"><button onclick="showAdminTab('ad1')" id="atab1" class="flex-1 py-2 rounded font-bold bg-blue-600 text-white text-xs">Overview</button><button onclick="showAdminTab('ad2')" id="atab2" class="flex-1 py-2 rounded font-bold bg-gray-300 text-xs">Analytics</button><button onclick="showAdminTab('ad3')" id="atab3" class="flex-1 py-2 rounded font-bold bg-gray-300 text-xs">Pending</button></div><div id="ad1"><div class="grid grid-cols-2 gap-4"><div class="bg-blue-500 text-white p-4 rounded"><div id="atr" class="text-2xl font-bold">0</div><div class="text-sm">Requests</div></div><div class="bg-green-500 text-white p-4 rounded"><div id="atp" class="text-2xl font-bold">0</div><div class="text-sm">Providers</div></div></div><div class="bg-white p-4 rounded shadow mt-4"><h3 class="font-bold mb-2">Requests</h3><div id="arl2"></div></div></div><div id="ad2" class="hidden space-y-4"><div class="bg-white p-4 rounded shadow"><h3 class="font-bold mb-3">ğŸ’° Revenue</h3><div class="text-3xl font-bold text-green-600 mb-2">KSh <span id="total-revenue">0</span></div><div class="text-sm">Jobs: <span id="completed-count">0</span></div><div class="text-sm">Avg: KSh <span id="avg-value">0</span></div></div><div class="bg-white p-4 rounded shadow"><h3 class="font-bold mb-3">Services</h3><canvas id="services-chart" height="200"></canvas></div><div class="bg-white p-4 rounded shadow"><h3 class="font-bold mb-3">Peak Hours</h3><canvas id="hours-chart" height="200"></canvas></div></div><div id="ad3" class="hidden"><h3 class="text-xl font-bold mb-4">Pending</h3><div id="pendl"></div></div></div></div></div><div id="em" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4">ğŸš¨ Request</h3><div id="mld" class="hidden bg-green-50 border-l-4 border-green-500 p-2 rounded mb-3 text-xs"><p class="font-bold">ğŸ“ Located</p><p id="mco"></p></div><button onclick="getLoc()" id="mlb" class="hidden w-full bg-blue-600 text-white py-2 rounded mb-3 font-bold">ğŸ“ Location</button><input type="tel" id="userphone" placeholder="Your Phone Number" class="w-full p-3 border rounded mb-3"><select id="is" class="w-full p-3 border rounded mb-3"><option value="">Service...</option><option>Towing</option><option>Tyre</option><option>Battery</option><option>Mechanical</option><option>Electrical</option><option>Other</option></select><input type="text" id="ci" placeholder="Specify..." class="hidden w-full p-3 border rounded mb-3"><textarea id="loc" placeholder="Location..." class="w-full p-3 border rounded mb-3" rows="3"></textarea><div class="mb-3"><label class="block font-bold mb-2 text-sm">ğŸ“¸ Photos</label><input type="file" multiple accept="image/*" id="ph" class="w-full p-2 border rounded text-sm"><div id="prev" class="grid grid-cols-3 gap-2 mt-2"></div></div><div class="grid grid-cols-2 gap-2 mb-3"><button onclick="setType('roadside')" id="tr" class="p-2 rounded border-2 bg-yellow-500 border-yellow-600 font-bold">ğŸ›£ï¸ Road</button><button onclick="setType('home')" id="th" class="p-2 rounded border-2 border-gray-300 font-bold">ğŸ  Home</button></div><div class="grid grid-cols-2 gap-2"><button onclick="submit()" class="bg-red-600 text-white py-2 rounded font-bold">Send</button><button onclick="hide('em')" class="bg-gray-300 py-2 rounded font-bold">Cancel</button></div></div></div><div id="ratemodal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4">Rate</h3><p id="rateprov" class="text-sm mb-3"></p><div class="flex justify-center gap-1 mb-4"><span class="star" onclick="setRating(1)">â˜…</span><span class="star" onclick="setRating(2)">â˜…</span><span class="star" onclick="setRating(3)">â˜…</span><span class="star" onclick="setRating(4)">â˜…</span><span class="star" onclick="setRating(5)">â˜…</span></div><textarea id="ratereview" placeholder="Review..." class="w-full p-3 border rounded mb-3" rows="3"></textarea><div class="grid grid-cols-2 gap-2"><button onclick="submitRating()" class="bg-yellow-500 text-black py-2 rounded font-bold">Submit</button><button onclick="hide('ratemodal')" class="bg-gray-300 py-2 rounded font-bold">Cancel</button></div></div></div><div id="quotemodal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-xl p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4">Send Quote</h3><p class="text-sm mb-2" id="qreqdet"></p><input type="number" id="qprice" placeholder="Price (KSh)" class="w-full p-3 border rounded mb-3"><input type="number" id="qeta" placeholder="ETA (min)" class="w-full p-3 border rounded mb-3"><textarea id="qnotes" placeholder="Notes..." class="w-full p-3 border rounded mb-3" rows="2"></textarea><div class="grid grid-cols-2 gap-2"><button onclick="sendQuote()" class="bg-green-600 text-white py-2 rounded font-bold">Send</button><button onclick="hide('quotemodal')" class="bg-gray-300 py-2 rounded font-bold">Cancel</button></div></div></div><div class="bg-gradient-to-r from-black to-gray-900 border-t-4 border-yellow-500 p-4 text-center fixed bottom-0 left-0 right-0"><p class="font-black text-yellow-400">âš«ğŸŸ¡ chapTAP autofix</p><p class="text-xs text-yellow-200">Your help is a TAP away! â€¢ ğŸ“ support@chaptapautofix.co.ke</p></div><script type="module">import{initializeApp}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';import{getFirestore,collection,addDoc,onSnapshot,updateDoc,doc,deleteDoc,query,orderBy}from'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';const cfg={apiKey:"AIzaSyC9bElB729BAemQgyloqaFSXOZhgqYjeFY",authDomain:"chaptap-autofix.firebaseapp.com",projectId:"chaptap-autofix",storageBucket:"chaptap-autofix.firebasestorage.app",messagingSenderId:"844892869830",appId:"1:844892869830:web:17a305b33d0679a068b3c7"};const app=initializeApp(cfg);const db=getFirestore(app);window.db=db;window.collection=collection;window.addDoc=addDoc;window.onSnapshot=onSnapshot;window.updateDoc=updateDoc;window.doc=doc;window.deleteDoc=deleteDoc;window.query=query;window.orderBy=orderBy;window.initApp();</script><script>let role='user',loc=null,type='roadside',pid=null,notifs=[],reqs=[],provs=[],quotes=[],reviews=[],curRateReq=null,curQuoteReq=null,selRating=0,viewingReqId=null,provRegLoc=null;window.initApp=function(){onSnapshot(collection(db,'providers'),s=>{provs=[];s.forEach(d=>provs.push({docId:d.id,...d.data()}));calcRatings();refresh()});onSnapshot(query(collection(db,'requests'),orderBy('timestamp','desc')),s=>{reqs=[];s.forEach(d=>reqs.push({docId:d.id,...d.data()}));refresh()});onSnapshot(collection(db,'quotes'),s=>{quotes=[];s.forEach(d=>quotes.push({docId:d.id,...d.data()}));refresh()});onSnapshot(collection(db,'reviews'),s=>{reviews=[];s.forEach(d=>reviews.push({docId:d.id,...d.data()}));calcRatings()});setTimeout(()=>{if(provs.length===0){addDoc(collection(db,'providers'),{id:Date.now(),name:'Mike Garage',phone:'0721122334',services:['Towing','Tyre','Battery'],location:'Nyali',lat:-4.0435,lng:39.6682,rating:4.5,status:'Approved',available:true,yearsInBusiness:5,certifications:'ASE',prices:{Towing:3000,Tyre:500,Battery:1500,Mechanical:2000,Electrical:1800}})}},2000);getLoc()};function calcRatings(){provs.forEach(p=>{const r=reviews.filter(x=>x.providerId===p.id);if(r.length>0){p.rating=(r.reduce((sum,x)=>sum+x.rating,0)/r.length).toFixed(1);p.reviewCount=r.length}else{p.rating=p.rating||0;p.reviewCount=0}})}function refresh(){up();updateHomepageStats();const v=document.querySelectorAll('#user>div:not(.hidden),#provider>div:not(.hidden),#admin>div:not(.hidden)')[0];if(v){const id=v.id;if(id==='pv')renderP();if(id==='ur')renderUR();if(id==='ar')renderAR();if(id==='mj')renderMJ();if(id==='myquotes')renderMyQuotes();if(id==='quotes')renderQuotesList();if(id==='ad2')renderAnalytics()}}function updateHomepageStats(){document.getElementById('hp-provs').textContent=provs.filter(p=>p.status==='Approved').length;document.getElementById('hp-completed').textContent=reqs.filter(r=>r.status==='Completed').length}function up(){document.getElementById('urc').textContent=reqs.length;document.getElementById('arc').textContent=reqs.filter(r=>r.status==='Pending').length;document.getElementById('atr').textContent=reqs.length;document.getElementById('atp').textContent=provs.filter(p=>p.status==='Approved').length;if(pid){const mj=reqs.filter(r=>r.providerId===pid&&r.status==='Accepted');document.getElementById('tj').textContent=mj.length;document.getElementById('cj').textContent=mj.filter(j=>j.status==='Completed').length;document.getElementById('mjc').textContent=mj.filter(j=>j.status!=='Completed').length;const myq=quotes.filter(q=>q.providerId===pid);document.getElementById('myqc').textContent=myq.length;const cp=provs.find(p=>p.id===pid);if(cp){document.getElementById('provrat').textContent=cp.rating||0;document.getElementById('provrevs').textContent=cp.reviewCount||0}}}function dist(a,b,c,d){const R=6371,x=(c-a)*Math.PI/180,y=(d-b)*Math.PI/180,z=Math.sin(x/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(y/2)**2;return(R*2*Math.atan2(Math.sqrt(z),Math.sqrt(1-z))).toFixed(1)}function addN(m){notifs.push({msg:m,time:new Date().toLocaleTimeString()});const b=document.getElementById('nb');b.textContent=notifs.length;b.classList.remove('hidden')}function showNotifs(){alert(notifs.length===0?'No notifications':notifs.map(n=>`${n.time}: ${n.msg}`).join('\n\n'))}function getLoc(){const b=document.getElementById('lb');b.textContent='Getting...';b.disabled=true;if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{loc={lat:p.coords.latitude,lng:p.coords.longitude};const t=`Lat: ${loc.lat.toFixed(4)}, Lng: ${loc.lng.toFixed(4)}`;document.getElementById('co').textContent=t;document.getElementById('ld').classList.remove('hidden');document.getElementById('gps').classList.remove('hidden');b.classList.add('hidden');document.getElementById('mco').textContent=t;document.getElementById('mld').classList.remove('hidden');document.getElementById('mlb').classList.add('hidden');addN('Located!')},()=>{alert('Enable GPS');b.textContent='ğŸ“ Use Location';b.disabled=false})}else{alert('Not supported')}}function captureProviderLocation(){const btn=document.getElementById('cap-loc-btn');btn.textContent='Getting...';btn.disabled=true;if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{provRegLoc={lat:p.coords.latitude,lng:p.coords.longitude};document.getElementById('prov-coords').textContent=`Lat: ${provRegLoc.lat.toFixed(4)}, Lng: ${provRegLoc.lng.toFixed(4)}`;document.getElementById('prov-loc-display').classList.remove('hidden');btn.textContent='âœ… Captured';btn.disabled=false;addN('Location captured!')},()=>{alert('Enable GPS');btn.textContent='ğŸ“ Capture Location';btn.disabled=false})}else{alert('Not supported')}}function setRole(r){role=r;['user','provider','admin'].forEach(x=>{document.getElementById('r'+x[0]).className=x===r?'px-4 py-2 rounded font-bold text-xs bg-yellow-500 text-black':'px-4 py-2 rounded font-bold text-xs bg-gray-700 text-white'});document.getElementById('user').classList.toggle('hidden',r!=='user');document.getElementById('provider').classList.toggle('hidden',r!=='provider');document.getElementById('admin').classList.toggle('hidden',r!=='admin');if(r==='user')show('uh');if(r==='provider')show('pl0');if(r==='admin')show('al')}function show(id){document.querySelectorAll('#user>div,#provider>div,#admin>div').forEach(e=>e.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');refresh();if(id==='em'&&!loc)document.getElementById('mlb').classList.remove('hidden')}function hide(id){document.getElementById(id).classList.add('hidden');if(id==='em'){document.getElementById('is').value='';document.getElementById('ci').classList.add('hidden');document.getElementById('loc').value='';document.getElementById('prev').innerHTML='';document.getElementById('ph').value='';document.getElementById('userphone').value=''}}function showAdminTab(id){['ad1','ad2','ad3'].forEach(t=>{document.getElementById(t).classList.add('hidden');document.getElementById('atab'+t.slice(-1)).className='flex-1 py-2 rounded font-bold bg-gray-300 text-xs'});document.getElementById(id).classList.remove('hidden');document.getElementById('atab'+id.slice(-1)).className='flex-1 py-2 rounded font-bold bg-blue-600 text-white text-xs';if(id==='ad1')updateA();if(id==='ad2')renderAnalytics();if(id==='ad3')updatePend()}function renderAnalytics(){const c=reqs.filter(r=>r.status==='Completed');const t=c.reduce((sum,r)=>sum+(r.acceptedPrice||0),0);document.getElementById('total-revenue').textContent=t.toLocaleString();document.getElementById('completed-count').textContent=c.length;document.getElementById('avg-value').textContent=c.length>0?(t/c.length).toFixed(0):0;const svcs={};reqs.forEach(r=>{svcs[r.issue]=(svcs[r.issue]||0)+1});const sc=document.getElementById('services-chart');if(sc){const ctx=sc.getContext('2d');if(window.servicesChart)window.servicesChart.destroy();window.servicesChart=new Chart(ctx,{type:'bar',data:{labels:Object.keys(svcs),datasets:[{label:'Requests',data:Object.values(svcs),backgroundColor:'rgba(59,130,246,0.8)'}]},options:{responsive:true,plugins:{legend:{display:false}}}})}const hrs={};reqs.forEach(r=>{if(r.timestamp){const h=new Date(r.timestamp).getHours();hrs[h]=(hrs[h]||0)+1}});const hc=document.getElementById('hours-chart');if(hc){const ctx2=hc.getContext('2d');if(window.hoursChart)window.hoursChart.destroy();window.hoursChart=new Chart(ctx2,{type:'line',data:{labels:Object.keys(hrs).sort((a,b)=>a-b).map(h=>`${h}:00`),datasets:[{label:'Requests',data:Object.keys(hrs).sort((a,b)=>a-b).map(h=>hrs[h]),borderColor:'rgba(34,197,94,1)',fill:true}]},options:{responsive:true,plugins:{legend:{display:false}}}})}}function renderP(){const l=document.getElementById('pl');l.innerHTML='';const ap=provs.filter(p=>p.status==='Approved');if(!ap.length){l.innerHTML='<p class="text-gray-500 text-center py-8">No providers</p>';return}ap.forEach(p=>{const d=loc?dist(loc.lat,loc.lng,p.lat,p.lng):null;const prvs=reviews.filter(r=>r.providerId===p.id).slice(0,2);let h=`<div class="bg-white p-4 rounded-xl shadow mb-3"><div class="flex justify-between mb-2"><div><div class="font-bold text-lg">${p.name}</div><div class="text-sm text-gray-600">ğŸ“ ${p.location}</div>${d?`<div class="text-xs text-blue-600 font-bold">ğŸ“ ${d} km</div>`:''}<div class="text-sm">${p.services.join(', ')}</div>${p.yearsInBusiness?`<div class="text-xs text-gray-600">ğŸ“… ${p.yearsInBusiness} years</div>`:''}${p.certifications?`<div class="text-xs text-gray-600">ğŸ“ ${p.certifications}</div>`:''}</div><div class="text-right"><div class="text-xl font-bold text-yellow-500">â­${p.rating||0}</div><div class="text-xs text-gray-600">${p.reviewCount||0} reviews</div></div></div>`;if(p.prices&&Object.keys(p.prices).length>0){h+=`<div class="bg-blue-50 p-2 rounded mb-2"><div class="font-bold text-xs mb-1">ğŸ’° Prices</div>`;Object.keys(p.prices).forEach(k=>{h+=`<div class="text-xs">â€¢ ${k}: KSh ${p.prices[k]}</div>`});h+=`</div>`}if(prvs.length>0){h+=`<div class="bg-gray-50 p-2 rounded mb-2 text-xs"><div class="font-bold mb-1">Reviews:</div>`;prvs.forEach(rv=>{h+=`<div>${'â­'.repeat(rv.rating)} ${rv.review?rv.review.substring(0,40)+'...':''}</div>`});h+=`</div>`}h+=`<div class="grid grid-cols-3 gap-2"><a href="tel:${p.phone}" class="bg-blue-600 text-white py-2 rounded text-center text-xs">ğŸ“</a><a href="https://wa.me/254${p.phone.substring(1)}" target="_blank" class="bg-green-600 text-white py-2 rounded text-center text-xs">ğŸ’¬</a><a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lng}" target="_blank" class="bg-gray-700 text-white py-2 rounded text-center text-xs">ğŸ—ºï¸</a></div></div>`;l.innerHTML+=h})}function renderUR(){const l=document.getElementById('url');if(!reqs.length){l.innerHTML='<p class="text-gray-500 text-center py-8">No requests</p>';return}l.innerHTML='';reqs.forEach(r=>{const sc=r.status==='Pending'?'bg-yellow-100 text-yellow-800':r.status==='Accepted'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800';const rq=quotes.filter(q=>q.requestId===r.id);let h=`<div class="bg-white p-4 rounded shadow mb-3"><div class="flex justify-between mb-2"><div><div class="font-bold">${r.issue}</div><div class="text-sm text-gray-600">${r.location}</div>${r.acceptedPrice?`<div class="text-sm font-bold text-green-600 mt-1">Price: KSh ${r.acceptedPrice}</div>`:''}</div><div class="px-2 py-1 rounded text-xs font-bold ${sc}">${r.status}</div></div>`;if(r.status==='Pending'&&rq.length>0){h+=`<button onclick="viewQuotes(${r.id},'${r.issue}')" class="w-full bg-yellow-500 text-black py-2 rounded font-bold text-sm mt-2">View ${rq.length} Quote(s)</button>`}else if(r.status==='Pending'){h+=`<div class="text-xs text-gray-500 mt-2">â³ Waiting...</div>`}if(r.status==='Completed'&&!r.rated){const prov=provs.find(p=>p.id===r.providerId);if(prov){h+=`<button onclick="showRateModal(${r.id},${prov.id},'${prov.name}')" class="w-full bg-yellow-500 text-black py-2 rounded font-bold text-sm mt-2">â­ Rate ${prov.name}</button>`}}h+=`</div>`;l.innerHTML+=h})}function viewQuotes(reqId,issue){viewingReqId=reqId;document.getElementById('quotereqtitle').textContent=issue;show('quotes')}function backFromQuotes(){viewingReqId=null;show('ur')}function renderQuotesList(){if(!viewingReqId)return;const l=document.getElementById('quoteslist');const rq=quotes.filter(q=>q.requestId===viewingReqId&&q.status!=='rejected').sort((a,b)=>a.price-b.price);if(!rq.length){l.innerHTML='<p class="text-gray-500 text-center py-8">No quotes</p>';return}l.innerHTML='';rq.forEach(q=>{const p=provs.find(x=>x.id===q.providerId);if(!p)return;l.innerHTML+=`<div class="bg-white p-4 rounded shadow mb-3"><div class="flex justify-between mb-2"><div><div class="font-bold text-lg">${p.name}</div><div class="text-sm text-gray-600">ğŸ“ ${p.location}</div><div class="text-sm">â­ ${p.rating} (${p.reviewCount})</div></div><div class="text-right"><div class="text-2xl font-bold text-green-600">KSh ${q.price}</div><div class="text-xs">ETA: ${q.eta||'N/A'} min</div></div></div>${q.notes?`<div class="text-sm mb-2">"${q.notes}"</div>`:''}<div class="grid grid-cols-2 gap-2"><button onclick="acceptQuote('${q.docId}',${q.providerId},${q.price})" class="bg-green-600 text-white py-2 rounded font-bold">âœ… Accept</button><button onclick="rejectQuote('${q.docId}',${q.providerId},'${p.name}')" class="bg-red-600 text-white py-2 rounded font-bold">âŒ Reject</button></div></div>`})}async function acceptQuote(qid,provId,price){if(!confirm(`Accept KSh ${price}?`))return;const req=reqs.find(r=>r.id===viewingReqId);await updateDoc(doc(db,'requests',req.docId),{status:'Accepted',providerId:provId,acceptedPrice:price});await updateDoc(doc(db,'quotes',qid),{accepted:true,status:'accepted'});quotes.filter(q=>q.requestId===viewingReqId&&q.docId!==qid).forEach(async q=>{await updateDoc(doc(db,'quotes',q.docId),{status:'rejected'})});addN('Accepted!');alert('âœ… Provider notified!');backFromQuotes()}async function rejectQuote(qid,provId,provName){if(!confirm(`Reject quote from ${provName}?`))return;await updateDoc(doc(db,'quotes',qid),{status:'rejected'});addN('Quote rejected');alert('âŒ Quote rejected. Provider has been notified.');renderQuotesList()}function showRateModal(reqId,provId,provName){curRateReq={reqId,provId};document.getElementById('rateprov').textContent=`Rate ${provName}`;selRating=0;document.querySelectorAll('.star').forEach(s=>s.classList.remove('active'));document.getElementById('ratemodal').classList.remove('hidden')}function setRating(r){selRating=r;document.querySelectorAll('.star').forEach((s,i)=>{if(i<r)s.classList.add('active');else s.classList.remove('active')})}async function submitRating(){if(!selRating){alert('Select rating');return}const rev=document.getElementById('ratereview').value;await addDoc(collection(db,'reviews'),{providerId:curRateReq.provId,rating:selRating,review:rev,timestamp:new Date().toISOString()});await updateDoc(doc(db,'requests',reqs.find(r=>r.id===curRateReq.reqId).docId),{rated:true});addN('Submitted!');alert('âœ… Thank you!');hide('ratemodal');document.getElementById('ratereview').value=''}function setType(t){type=t;document.getElementById('tr').className=t==='roadside'?'p-2 rounded border-2 bg-yellow-500 border-yellow-600 font-bold':'p-2 rounded border-2 border-gray-300 font-bold';document.getElementById('th').className=t==='home'?'p-2 rounded border-2 bg-yellow-500 border-yellow-600 font-bold':'p-2 rounded border-2 border-gray-300 font-bold'}async function submit(){const i=document.getElementById('is').value,c=document.getElementById('ci').value,l=document.getElementById('loc').value,ph=document.getElementById('userphone').value;if(!i||!l||!ph){alert('Fill all fields including phone number');return}const fi=i==='Other'?c:i;await addDoc(collection(db,'requests'),{id:Date.now(),issue:fi,location:l,type:type,userPhone:ph,photos:Array.from(document.getElementById('ph').files).map(f=>f.name),userLat:loc?.lat,userLng:loc?.lng,status:'Pending',timestamp:new Date().toISOString(),rated:false});addN('Sent!');hide('em');alert('âœ… Request sent!')}function pLogin(){const ph=document.getElementById('pp').value,p=provs.find(x=>x.phone===ph&&x.status==='Approved');if(p){pid=p.id;hide('pl0');show('pd');document.getElementById('pn').textContent=p.name;document.getElementById('plc').textContent=p.location;if(p.prices){['p1','p2','p3','p4','p5'].forEach((id,i)=>{document.getElementById(id).value=p.prices[['Towing','Tyre','Battery','Mechanical','Electrical'][i]]||''})}up()}else alert('Not found')}async function registerP(){const n=document.getElementById('rname').value,ph=document.getElementById('rphone').value,l=document.getElementById('rloc').value,y=document.getElementById('ryears').value,c=document.getElementById('rcert').value,s=Array.from(document.querySelectorAll('.srv:checked')).map(x=>x.value);if(!n||!ph||!l||!s.length){alert('Fill all');return}if(!provRegLoc){alert('Capture location');return}await addDoc(collection(db,'providers'),{id:Date.now(),name:n,phone:ph,services:s,location:l,lat:provRegLoc.lat,lng:provRegLoc.lng,rating:0,status:'Pending',available:false,yearsInBusiness:parseInt(y)||0,certifications:c||'',prices:{}});addN('Registered!');alert('âœ… Awaiting approval');show('pl0');provRegLoc=null;document.getElementById('prov-loc-display').classList.add('hidden');document.getElementById('cap-loc-btn').textContent='ğŸ“ Capture Location';['rname','rphone','rloc','ryears','rcert'].forEach(id=>document.getElementById(id).value='');document.querySelectorAll('.srv').forEach(x=>x.checked=false)}async function savePrices(){const prices={};['p1','p2','p3','p4','p5'].forEach((id,i)=>{const v=document.getElementById(id).value;if(v)prices[['Towing','Tyre','Battery','Mechanical','Electrical'][i]]=parseInt(v)});await updateDoc(doc(db,'providers',provs.find(p=>p.id===pid).docId),{prices});addN('Saved!');alert('âœ… Prices saved!')}async function toggleA(){const p=provs.find(x=>x.id===pid);await updateDoc(doc(db,'providers',p.docId),{available:!p.available})}function renderAR(){const l=document.getElementById('arl'),or=reqs.filter(r=>r.status==='Pending');if(!or.length){l.innerHTML='<p class="text-gray-500 text-center py-8">None</p>';return}l.innerHTML='';or.forEach(r=>{const aq=quotes.find(q=>q.requestId===r.id&&q.providerId===pid);const ml=r.userLat&&r.userLng?`<a href="https://www.google.com/maps/dir/?api=1&destination=${r.userLat},${r.userLng}" target="_blank" class="text-xs text-blue-600 underline block mt-1">ğŸ—ºï¸ Directions</a>`:'';l.innerHTML+=`<div class="bg-white p-4 rounded shadow mb-3"><div class="font-bold">${r.issue}</div><div class="text-sm text-gray-600">${r.location}</div>${ml}${aq?'<div class="text-xs text-green-600 mt-2">âœ… Quote sent</div>':`<button onclick="openQuoteModal(${r.id},'${r.issue}')" class="mt-2 w-full bg-green-600 text-white py-2 rounded font-bold">ğŸ’° Send Quote</button>`}</div>`})}function renderMyQuotes(){const l=document.getElementById('myquoteslist'),myq=quotes.filter(q=>q.providerId===pid);if(!myq.length){l.innerHTML='<p class="text-gray-500 text-center py-8">None</p>';return}l.innerHTML='';myq.forEach(q=>{const req=reqs.find(r=>r.id===q.requestId);if(!req)return;const st=q.status==='accepted'?{t:'âœ… Accepted',c:'bg-green-100 text-green-700'}:q.status==='rejected'?{t:'âŒ Rejected',c:'bg-red-100 text-red-700'}:{t:'â³ Pending',c:'bg-yellow-100 text-yellow-700'};const reqStatus=req.status==='Accepted'||req.status==='Completed'?` â€¢ Request: ${req.status}`:'';l.innerHTML+=`<div class="bg-white p-4 rounded shadow mb-3"><div class="flex justify-between mb-2"><div><div class="font-bold">${req.issue}</div><div class="text-sm text-gray-600">${req.location}${reqStatus}</div></div><div class="text-2xl font-bold text-green-600">KSh ${q.price}</div></div><div class="px-2 py-1 rounded text-xs font-bold inline-block ${st.c}">${st.t}</div>${q.status==='rejected'&&req.status==='Pending'?`<button onclick="requote(${req.id},'${req.issue}')" class="mt-2 w-full bg-blue-600 text-white py-2 rounded font-bold text-sm">ğŸ”„ Requote</button>`:q.status==='rejected'&&(req.status==='Accepted'||req.status==='Completed')?`<div class="text-xs text-gray-500 mt-2 italic">âŒ Job already taken by another provider</div>`:''}</div>`})}function requote(reqId,issue){const req=reqs.find(r=>r.id===reqId);if(!req){alert('âš ï¸ Request not found');return}if(req.status==='Accepted'){const otherProv=provs.find(p=>p.id===req.providerId);alert(`âŒ Sorry! This job was already accepted by ${otherProv?otherProv.name:'another provider'} for KSh ${req.acceptedPrice}.`);return}if(req.status==='Completed'){alert('âŒ Sorry! This job has already been completed by another provider.');return}openQuoteModal(reqId,issue)}function openQuoteModal(reqId,issue){curQuoteReq=reqId;document.getElementById('qreqdet').textContent=`Request: ${issue}`;const prov=provs.find(p=>p.id===pid);if(prov&&prov.prices){const svc=issue.split(' ')[0];if(prov.prices[svc])document.getElementById('qprice').value=prov.prices[svc]}document.getElementById('quotemodal').classList.remove('hidden')}async function sendQuote(){const price=document.getElementById('qprice').value,eta=document.getElementById('qeta').value,notes=document.getElementById('qnotes').value;if(!price){alert('Enter price');return}const req=reqs.find(r=>r.id===curQuoteReq);if(req&&(req.status==='Accepted'||req.status==='Completed')){alert('âŒ Sorry! This job has already been taken by another provider.');hide('quotemodal');return}await addDoc(collection(db,'quotes'),{requestId:curQuoteReq,providerId:pid,price:parseInt(price),eta:parseInt(eta)||null,notes:notes||'',timestamp:new Date().toISOString(),accepted:false,status:'pending'});addN('Sent!');alert('âœ… Quote sent!');hide('quotemodal');['qprice','qeta','qnotes'].forEach(id=>document.getElementById(id).value='');renderAR()}function renderMJ(){const l=document.getElementById('mjl'),mj=reqs.filter(r=>r.providerId===pid&&r.status==='Accepted');if(!mj.length){l.innerHTML='<p class="text-gray-500 text-center py-8">None</p>';return}l.innerHTML='';mj.forEach(r=>{const ml=r.userLat&&r.userLng?`<a href="https://www.google.com/maps/dir/?api=1&destination=${r.userLat},${r.userLng}" target="_blank" class="text-xs text-blue-600 underline block mt-1">ğŸ—ºï¸ Navigate</a>`:'';const cb=r.status!=='Completed'?`<button onclick="complete('${r.docId}')" class="mt-2 w-full bg-green-600 text-white py-2 rounded font-bold">âœ… Complete</button>`:'<div class="text-xs text-green-600 mt-2">âœ… Done</div>';const contactInfo=r.userPhone?`<div class="bg-blue-50 p-2 rounded mt-2 mb-2"><div class="font-bold text-xs mb-1">ğŸ‘¤ Customer Contact</div><div class="text-sm mb-2">ğŸ“ ${r.userPhone}</div><div class="grid grid-cols-2 gap-2"><a href="tel:${r.userPhone}" class="bg-blue-600 text-white py-2 rounded text-center text-xs font-bold">ğŸ“ Call</a><a href="https://wa.me/254${r.userPhone.substring(1)}" target="_blank" class="bg-green-600 text-white py-2 rounded text-center text-xs font-bold">ğŸ’¬ WhatsApp</a></div></div>`:'';l.innerHTML+=`<div class="bg-white p-4 rounded shadow mb-3"><div class="font-bold">${r.issue}</div><div class="text-sm text-gray-600">${r.location}</div><div class="text-sm font-bold text-green-600 mt-1">KSh ${r.acceptedPrice}</div>${contactInfo}${ml}${cb}</div>`})}async function complete(docId){await updateDoc(doc(db,'requests',docId),{status:'Completed'});addN('Completed!');alert('âœ… Job done!')}function aLogin(){if(document.getElementById('ap').value==='1234'){hide('al');show('ad');showAdminTab('ad1')}else alert('Wrong PIN')}function updateA(){document.getElementById('atr').textContent=reqs.length;document.getElementById('atp').textContent=provs.filter(p=>p.status==='Approved').length;const l=document.getElementById('arl2');if(!reqs.length){l.innerHTML='<p class="text-gray-500 py-4 text-center">None</p>';return}l.innerHTML='';reqs.forEach(r=>{l.innerHTML+=`<div class="border-b py-2"><div class="font-semibold">${r.issue}</div><div class="text-sm text-gray-600">${r.location} - ${r.status}${r.acceptedPrice?' - KSh '+r.acceptedPrice:''}</div></div>`})}function updatePend(){const l=document.getElementById('pendl'),p=provs.filter(x=>x.status==='Pending');if(!p.length){l.innerHTML='<p class="text-gray-500 text-center py-8">None</p>';return}l.innerHTML='';p.forEach(x=>{l.innerHTML+=`<div class="bg-white p-4 rounded shadow mb-3"><div class="font-bold text-lg">${x.name}</div><div class="text-sm text-gray-600">ğŸ“ ${x.phone}</div><div class="text-sm text-gray-600">ğŸ“ ${x.location}</div><div class="text-sm text-gray-600">ğŸ—ºï¸ Lat: ${x.lat.toFixed(4)}, Lng: ${x.lng.toFixed(4)}</div><div class="text-sm text-gray-600">ğŸ“… ${x.yearsInBusiness} years</div><div class="text-sm text-gray-600">ğŸ“ ${x.certifications}</div><div class="text-sm mt-1">${x.services.join(', ')}</div><div class="grid grid-cols-2 gap-2 mt-3"><button onclick="approveP('${x.docId}')" class="bg-green-600 text-white py-2 rounded font-bold">âœ…</button><button onclick="rejectP('${x.docId}')" class="bg-red-600 text-white py-2 rounded font-bold">âŒ</button></div></div>`})}async function approveP(docId){await updateDoc(doc(db,'providers',docId),{status:'Approved',available:true,rating:4.0});addN('Approved!');alert('âœ… Approved!')}async function rejectP(docId){if(confirm('Reject?')){await deleteDoc(doc(db,'providers',docId));alert('Rejected')}}document.getElementById('is').addEventListener('change',e=>{document.getElementById('ci').classList.toggle('hidden',e.target.value!=='Other')});document.getElementById('ph').addEventListener('change',e=>{const p=document.getElementById('prev');p.innerHTML='';Array.from(e.target.files).forEach(f=>{const r=new FileReader();r.onload=ev=>{const i=document.createElement('img');i.src=ev.target.result;i.className='w-full h-20 object-cover rounded border';p.appendChild(i)};r.readAsDataURL(f)})});</script></body></html>
