<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>chapTAP Autofix</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// ICONS
const Bell = ({size=24}) => <span style={{fontSize:size}}>üîî</span>;
const AlertCircle = ({size=24}) => <span style={{fontSize:size}}>üö®</span>;
const X = ({size=24}) => <span style={{fontSize:size}}>‚ùå</span>;
const Send = ({size=24}) => <span style={{fontSize:size}}>üì§</span>;

// STORAGE
const storage = {
  get: (key) => { try { return JSON.parse(localStorage.getItem(key)) || null; } catch { return null; } },
  set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)) } catch(e) { console.error(e); } }
};

// CHAT MODAL
const ChatModal = ({ provider, messages, onClose, onSend }) => {
  const [message, setMessage] = useState('');
  const messagesEndRef = useRef(null);
  useEffect(()=>{ messagesEndRef.current?.scrollIntoView({behavior:'smooth'}) }, [messages]);
  const handleSend = () => { if(message.trim()){ onSend(message); setMessage(''); } };
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl max-w-md w-full h-[600px] flex flex-col shadow-2xl">
        <div className="bg-gradient-to-r from-purple-600 to-purple-700 p-4 rounded-t-2xl flex justify-between items-center">
          <div>
            <h3 className="font-bold text-white">{provider.name}</h3>
            <p className="text-xs text-purple-100">{provider.services.join(', ')}</p>
          </div>
          <button onClick={onClose} className="text-white"><X size={24}/></button>
        </div>
        <div className="flex-1 overflow-y-auto p-4 space-y-3">
          {messages.length===0 ? <p className="text-center text-gray-400 mt-8">No messages yet</p> :
            messages.map((msg, idx)=>(
              <div key={idx} className={`flex ${msg.sender==='user'?'justify-end':'justify-start'}`}>
                <div className={`max-w-[70%] p-3 rounded-lg ${msg.sender==='user'?'bg-purple-600 text-white':'bg-gray-200 text-gray-800'}`}>
                  <p className="text-sm">{msg.text}</p>
                  <p className="text-xs mt-1 opacity-70">{msg.timestamp}</p>
                </div>
              </div>
            ))
          }
          <div ref={messagesEndRef}></div>
        </div>
        <div className="p-4 flex gap-2">
          <input type="text" placeholder="Type a message..." value={message} onChange={e=>setMessage(e.target.value)} className="flex-1 p-3 border rounded-xl"/>
          <button onClick={handleSend} className="bg-purple-600 text-white px-4 py-3 rounded-xl flex items-center"><Send/></button>
        </div>
      </div>
    </div>
  );
};

// RATING MODAL
const RatingModal = ({ request, onClose, onSubmit }) => {
  const [rating,setRating] = useState(5);
  const [comment,setComment] = useState('');
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
        <h3 className="font-bold text-lg mb-4">Rate your service</h3>
        <p className="mb-2">Request: {request.issue}</p>
        <input type="number" min="1" max="5" value={rating} onChange={e=>setRating(e.target.value)} className="w-full p-3 border rounded-lg mb-2" placeholder="Rating 1-5"/>
        <textarea value={comment} onChange={e=>setComment(e.target.value)} className="w-full p-3 border rounded-lg mb-4" placeholder="Comment (optional)"/>
        <div className="flex justify-between">
          <button onClick={()=>onSubmit(request.id,rating,comment)} className="bg-purple-600 text-white px-4 py-2 rounded-lg">Submit</button>
          <button onClick={onClose} className="bg-gray-300 px-4 py-2 rounded-lg">Cancel</button>
        </div>
      </div>
    </div>
  );
};

// MAIN APP
const ChapTapAutofix = () => {
  const [userType,setUserType]=useState('user');
  const [currentView,setCurrentView]=useState('home');
  const [providers,setProviders]=useState([]);
  const [shops,setShops]=useState([]);
  const [requests,setRequests]=useState([]);
  const [chats,setChats]=useState({});
  const [notifications,setNotifications]=useState([]);
  const [location,setLocation]=useState(null);
  const [gpsActive,setGpsActive]=useState(false);
  const [showEmergencyModal,setShowEmergencyModal]=useState(false);
  const [showNotifications,setShowNotifications]=useState(false);
  const [selectedProvider,setSelectedProvider]=useState(null);
  const [showChat,setShowChat]=useState(false);
  const [showRating,setShowRating]=useState(false);
  const [selectedRequest,setSelectedRequest]=useState(null);
  const [emergencyForm,setEmergencyForm]=useState({issue:'',locationType:'roadside',locationDesc:'',files:[]});
  const [providerForm,setProviderForm]=useState({name:'',phone:'',services:[],experience:'',idNumber:'',location:''});

  useEffect(()=>{
    setProviders(storage.get('providers')||[
      {id:1,name:'Mike Garage',phone:'0721122334',services:['Towing','Tyre'],location:'Nyali',rating:4.5,status:'Approved',available:true},
      {id:2,name:'Quick Fix Auto',phone:'0733445566',services:['Battery'],location:'CBD',rating:4.3,status:'Approved',available:true}
    ]);
    setShops(storage.get('shops')||[
      {id:1,name:'Mombasa Oils Centre',location:'Nyali',type:'Lubricants',products:'Engine Oil, Brake Fluid',phone:'0712345678',rating:4.5},
      {id:2,name:'AutoSpare Hub',location:'Changamwe',type:'Parts',products:'Belts, Plugs',phone:'0721987654',rating:4.3}
    ]);
    setRequests(storage.get('requests')||[]);
    setChats(storage.get('chats')||{});
    setNotifications(storage.get('notifications')||[]);
    requestLocation();
  },[]);

  useEffect(()=>{storage.set('providers',providers)},[providers]);
  useEffect(()=>{storage.set('requests',requests)},[requests]);
  useEffect(()=>{storage.set('chats',chats)},[chats]);
  useEffect(()=>{storage.set('notifications',notifications)},[notifications]);

  const requestLocation=()=>{
    if(!navigator.geolocation){setGpsActive(false);return;}
    setGpsActive(true);
    navigator.geolocation.getCurrentPosition(pos=>setLocation({lat:pos.coords.latitude,lng:pos.coords.longitude}), ()=>setGpsActive(false));
  };

  const addNotification=(message,type='info')=>{
    setNotifications(prev=>[{id:Date.now(),message,type,timestamp:new Date().toLocaleString()},...prev]);
  };

  const handleEmergencySubmit=()=>{
    if(!emergencyForm.issue || !emergencyForm.locationDesc){alert('Fill required fields');return;}
    const newRequest={id:Date.now(),...emergencyForm,location,status:'Open',timestamp:new Date().toLocaleString(),driverName:'Current User'};
    setRequests(prev=>[newRequest,...prev]);
    addNotification('Emergency request submitted!','success');
    setShowEmergencyModal(false);
    setEmergencyForm({issue:'',locationType:'roadside',locationDesc:'',files:[]});
  };
  const handleFileUpload=(e)=>{setEmergencyForm(prev=>({...prev,files:Array.from(e.target.files).map(f=>f.name)}))};

  const toggleService=(service)=>{setProviderForm(prev=>({...prev,services:prev.services.includes(service)?prev.services.filter(s=>s!==service):[...prev.services,service]}))};
  const handleProviderRegistration=()=>{
    if(!providerForm.name || !providerForm.phone || providerForm.services.length===0){alert('Fill all fields');return;}
    setProviders(prev=>[...prev,{id:Date.now(),...providerForm,status:'Pending',rating:0,available:false}]);
    addNotification('Registration submitted for approval','info');
    setCurrentView('home');setProviderForm({name:'',phone:'',services:[],experience:'',idNumber:'',location:''});
  };

  const sendMessage=(providerId,text)=>{
    const key=`chat_${providerId}`;
    const newMsg={sender:'user',text,timestamp:new Date().toLocaleTimeString()};
    setChats(prev=>({...prev,[key]:[...(prev[key]||[]),newMsg]}));
  };

  const submitRating=(requestId,rating,comment)=>{
    addNotification('Rating submitted','success');
    setShowRating(false);
    setSelectedRequest(null);
  };

  return (
    <div className="min-h-screen relative bg-gray-100">
      {/* HEADER */}
      <header className="bg-gradient-to-r from-black via-gray-900 to-black p-4 text-white flex justify-between items-center shadow-xl">
        <h1 className="font-black text-lg">‚ö´üü° chapTAP Autofix</h1>
        <div className="flex items-center gap-2">
          <button onClick={()=>setShowNotifications(!showNotifications)}><Bell/></button>
          <button onClick={()=>setShowEmergencyModal(true)} className="bg-red-600 px-3 py-1 rounded-lg font-bold hover:bg-red-700">Emergency</button>
        </div>
      </header>

      {/* NOTIFICATIONS */}
      {showNotifications && <div className="absolute top-16 right-4 w-80 bg-white rounded-lg shadow-xl p-4 z-50">
        <h3 className="font-bold mb-2">Notifications</h3>
        {notifications.length===0 ? <p className="text-sm text-gray-500">No notifications yet</p> : notifications.map(n=>(
          <div key={n.id} className="text-xs p-2 border-b border-gray-200">
            <p className="font-semibold">{n.type.toUpperCase()}</p>
            <p>{n.message}</p>
            <p className="text-gray-400">{n.timestamp}</p>
          </div>
        ))}
      </div>}

      {/* VIEWS */}
      {currentView==='home' && (
        <div className="p-4 space-y-4 max-w-md mx-auto mt-4">
          <div className="flex justify-center gap-2 mb-4">
            <button onClick={()=>setUserType('user')} className={`px-6 py-2 rounded-lg font-bold ${userType==='user'?'bg-yellow-500 text-black':'bg-gray-700 text-white'}`}>User</button>
            <button onClick={()=>setUserType('admin')} className={`px-6 py-2 rounded-lg font-bold ${userType==='admin'?'bg-gray-800 text-white':'bg-gray-700 text-white'}`}>Admin</button>
          </div>
          <div className="flex flex-col gap-4">
            <button onClick={()=>setShowEmergencyModal(true)} className="w-full bg-red-600 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2"><AlertCircle size={20}/> EMERGENCY HELP</button>
            <button onClick={()=>setCurrentView('providers')} className="w-full bg-black text-yellow-400 py-4 rounded-xl font-bold hover:bg-gray-900 flex items-center justify-center gap-2">‚ö´üü° Find Service Providers</button>
            <button onClick={()=>setCurrentView('shops')} className="w-full bg-yellow-500 text-black py-4 rounded-xl font-bold hover:bg-yellow-600 flex items-center justify-center gap-2">üü° Browse Auto Shops</button>
            <button onClick={()=>setCurrentView('providerRegistration')} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700">Register as Service Provider</button>
            <button onClick={()=>setCurrentView('requests')} className="w-full bg-purple-600 text-white py-4 rounded-xl font-bold hover:bg-purple-700 flex justify-between items-center px-4">My Request History <span className="bg-purple-800 px-2 py-1 rounded-full text-xs">{requests.length}</span></button>
          </div>
        </div>
      )}

      {/* MODALS */}
      {showEmergencyModal && (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
            <h3 className="font-bold text-lg mb-4">Emergency Help</h3>
            <input type="text" placeholder="Issue" value={emergencyForm.issue} onChange={e=>setEmergencyForm({...emergencyForm,issue:e.target.value})} className="w-full p-3 border rounded-lg mb-2"/>
            <input type="text" placeholder="Location Description" value={emergencyForm.locationDesc} onChange={e=>setEmergencyForm({...emergencyForm,locationDesc:e.target.value})} className="w-full p-3 border rounded-lg mb-2"/>
            <input type="file" multiple onChange={e=>setEmergencyForm({...emergencyForm,files:Array.from(e.target.files).map(f=>f.name)})} className="mb-2"/>
            <div className="flex justify-between mt-4">
              <button onClick={handleEmergencySubmit} className="bg-red-600 text-white px-4 py-2 rounded-lg">Submit</button>
              <button onClick={()=>setShowEmergencyModal(false)} className="bg-gray-300 px-4 py-2 rounded-lg">Cancel</button>
            </div>
          </div>
        </div>
      )}

      {showChat && selectedProvider && <ChatModal provider={selectedProvider} messages={chats[`chat_${selectedProvider.id}`]||[]} onClose={()=>setShowChat(false)} onSend={msg=>sendMessage(selectedProvider.id,msg)}/>}

      {showRating && selectedRequest && <RatingModal request={selectedRequest} onClose={()=>setShowRating(false)} onSubmit={submitRating}/>}

      <footer className="bg-gradient-to-r from-black via-gray-900 to-black border-t-4 border-yellow-500 p-4 text-center fixed bottom-0 left-0 right-0 max-w-md mx-auto shadow-2xl">
        <p className="font-black tracking-wider text-yellow-400 text-lg">‚ö´üü° chapTAP Autofix</p>
        <p className="text-xs text-yellow-200 mt-1">üìû support@chaptapautofix.co.ke | Premium Roadside Help</p>
      </footer>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<ChapTapAutofix/>);
</script>
</body>
</html>
